$PSDocId: Document Version 1.0 for Runtime Library Version 3.3$
* ストリーミングライブラリ 

	ストリーミングライブラリは、大容量メディア に格納された
	動画像や音や頂点データなどのリアルタイムデータをFRAMEという単位
	で連続的にとり出すための関数群です。FRAMEとはCDROMのデータの
	最小単位であるセクタが１ないしは複数まとまったものです。

	大容量メディアとしては CDROM、半導体メモリ、ハード
	ディスクが現状では想定されますが、今回のバージョンでは
	CDROM及びエミュレーション用に半導体メモリがサポートされています。

	ストリーミングライブラリを使ってとり出された１FRAMEの
	データは「完全で」「欠落がなく」「アドレス上での連続性」
	が保証されます。

	ライブラリ関数には以下の機能のものがあります。

	・CDROMとビデオとの同期処理
	・CDROMデータのエラー処理
	・連続的なデータの読みだし
	・中断処理
	・終了処理

	ストリーミングライブラリは CD-ROM をアクセスして、単位時間当た
	りに必要なデータをメモリ上に置くまでのことを担当します。
	これらのデータを画面に表示したり、音声として出力したりという部
	分についてはユーザープログラムで対応することになります。


* ライブラリファイル
	ストリーミングライブラリのファイル名は 「libcd.lib」です。
	各サービスを呼び出すプログラムは、必ずこのファイルをリンクする必要が
	あります。


* インクルードヘッダ
	ストリーミングライブラリのインクルードヘッダは「libcd.h」です。
	各種のデータ構造、マクロは全てこのファイルで定義されています。
	各サービスを呼び出すプログラムは必ずこのファイルをインクルードする
	必要があります。


* ストリーミング
	ストリーミングとはビデオ再生や３D頂点アニメーションなど、
	リアルタイム再生されるために作られたデータをリアルタイムに
	処理することです。

	CDROMのセクターを連続的に読みだし処理することでCDROMの転送レート
	をフルに使った処理を実現します。


* 同期制御
	連続的にセクタを読み処理を行なうには １FRAMEの処理が１FRAME
	をCDROMから読み出す時間以内になされなければなりません。
	さもないと 処理が追いつかずCDROMのデータを貯めておくバッファが
	溢れてしまいます。

	しかし 1FRAMEの処理はCDROMのREADに同期していないので 1FRAMEの
	読み出しの時間以内に 処理の時間を必ず終らせる、つまり同期を
	とることは 困難です。

	ストリーミングライブラリは同期をライブラリが吸収します。
	もし1FRAMEの処理が1FRAMEの読み込みの時間を越える場合は
	FRAME単位で読み込んだデータを捨てます。このメカニズムにより
	CDROMから読み込まれたデータはFRAME単位で一貫性があり常に
	処理の速度に 同期させて データを読み込むことができます。

	この機能は CDROMのデータをリングバッファに格納することにより
	実現しています。


*リングバッファ
	ストリーミングライブラリはリングバッファをもち、読み込まれた
	データはこのリングバッファに 格納されロックされます。

	リングバッファのサイズはセクタ単位で任意であり メインプログラムで
	その領域を指定する必要があり StSetRing()でライブラリに通知します。

	プログラマはそのデータを処理し終ったらロックを解除する必要が
	あります。ロックの解除は StFreeRing()で行ないます。

	リングバッファが、ロックされたデータでいっぱいになった場合、
	ライブラリはFRAME単位でデータを捨てます。そしてロックが
	解除されしだいデータを読みこみます。

	ライブラリは リングバッファのアドレスの切れ目が １FRAMEの
	データの途中にこないよう自動的に調整します。


* リングバッファフォーマット

	リングバッファのフォーマットは以下の通りです。

	リングバッファの領域は大きく二つの領域にわかれており
	それぞれが リングバッファとして存在します。アドレス的に
	上位の部分が ヘッダ領域、下位の部分がデータ領域です。

	ヘッダ領域は１セクタ ８ワード（３２バイト）のリングバッファです。
	データ領域は１セクタ ５０４ワード（２０１６バイト）のリングバッ
	ファです。


	例えば リングバッファのサイズを４にした場合以下のよう
	にデータが読み込まれます。

			________________________	
			|    SECTOR 0 HEADER	|	^
			|_______________________|	|
			|    SECTOR 1 HEADER	|	|
			|_______________________|     32 byte
			|    SECTOR 2 HEADER	|	|
			|_______________________|	|
			|    SECTOR 3 HEADER	|	|
			|_______________________|	v
			|			|	^
			|			|	|
			|  SECTOR 0 USER DATA	|	|
			|			|	|
			|			|	|
			|			|	|
			|_______________________|	|
			|			|	|
			|			|	|
			|  SECTOR 1 USER DATA	|	|
			|			|    2016 byte
			|			|	|
			|			|	|
			|_______________________|	|
			|			|	|
			|			|	|
			|  SECTOR 2 USER DATA	|	|
			|			|	|
			|			|	|
			|			|	|
			|_______________________|	|
			|			|	|
			|			|	|
			|  SECTOR 3 USER DATA	|	|
			|			|	|
			|			|	|
			|			|	|
			|_______________________|	v



	CDROMからデータが読み込まれるとそのセクタはロックされます。
	
	StGetNext()が呼ばれると1FRAME分のデータが揃ったところで
	FRAMEの先頭アドレスが返ります。プログラマはそのFRAMEの
	データを処理し終ったら StFreeRing()でそのFRAMEの領域を
	解放します。

	解放された領域には 新しいデータがCDROMから読み込まれます。


* メモリストリーミング
	リングバッファの領域を １シーケンスが入るくらい大きくとり
	リングバッファが溢れる前に読み込みを終了すると シーケンスの
	繰り返しだけならばCDROMからではなくメモリからストリーミングを
	させることができます。

	StSetStream()の引数の end_flame を０に設定すると 自動的に
	リングバッファに入り切るたけで CDROMからの読み込みを終了させること
	ができます。

	このようにすることで リングバッファの折り返りがおこらず
	メモリストリーミングを容易に実現することができます。


* 24bit 動画再生時の割り込み制御
	
	関数 StCdInterrupt() はストリーミングライブラリの内部関数で
	あり通常は呼び必要はありません。CDROMからの割り込みによって
	自動的にこの関数が呼ばれます。

	ただしこの関数はCDROMからメインメモリへ比較的大きな ２KBYTE
	のDMA転送を行なうため BUSが比較的長い間占有されてしまいます。
	そのため、この関数の呼び出しを制御する方法が提供されています。

	RGB２４ビットの動画を再生する時にこの機能を使用しています。

	StSetStream(),StSetEmulate()の引数のmodeで 24bit modeをONにすると
	自動的にStCdInterrupt()が呼ばれなくなり代わりに StCdIntrFlagという
	フラグがセットされます。プログラマはこのフラグを見張っていて
	適当な時に この関数を呼ぶことでタイミングを制御することとができます。
	

* CD-ROM メモリエミュレーション
	エミュレーションとは CDROMからデータをとってくる代わりに
	CDROMからとってくるのと同じタイミングで、あらかじめCDROM
	と同じデータが格納してあるメインメモリから データをとって
	くることをいいます。

	エミュレーションにより いちいちCDROMにデータを焼き込む
	ことなく 内容の確認を行なうことができます。

	エミュレーションのデータはあらかじめデバッガなどでメモリに
	ロードしておく必要があります。ロードする領域は任意ですが
	エミュレーションデータは連続領域を必要とするため上位の
	アドレスがいいでしょう。StSetEmulate()の第１引数で、
	読み込んだ先頭アドレスをライブラリに渡す必要があります。

	エミュレーションをスタートさせるとCDROMが回りはじめますが
	これは タイミングをもらうだけで実際のデータは エミュレーション
	データが使われます。よって CDが終ってしまったらエミュレーションも
	止まります。

	エミュレーションデータが終ると自動的に最初に巻き戻って
	エミュレーションは続行されます。


* 使用する割り込み関数
	ストリーミングライブラリは 以下の２つの割り込み関数を使用します。
	
	=======================================================
	関数名		内容
	-------------------------------------------------------
	CdDataCallback	セクタデータ転送終了コールバック
	CdReadyCallback	セクタデータレディコールバック
	-------------------------------------------------------
	
* CDROMドライブの制御について
	CDROMドライブの制御についてはLIBCDを御使用ください。詳細は
	libcd のドキュメントを参照して下さい。




