$PSDocId: Document Version 1.0 for Runtime Library Version 3.3$
TODデータによるアニメーション


アニメーションツールで作成したデータを利用し、libgs上で3Dアニメーショ
ン再生を行なう場合の処理について解説します。

libgsでは最小限の機能を持ったGsDOBJ2用のTOD処理関数が用意されています
が、同様の機能を持ったルーチンのソースが公開されていますので、ここでは
サンプルプログラム中の関数名／構造体名で解説します。

TODデータを処理するプログラムの例はサンプルプログラムの
PSX\SAMPLE\GRAPHICS\TODの下に格納されています。


* 必要となるデータ

アニメーションツールが export するデータには次のものがあります。

	***.tod			アニメーションデータ(TODデータ)
	***.tmd			モデリングデータ
	***.h			モデリングデータリスト

この他、TMDデータがテクスチャマップされている場合には対応したTIMファイ
ルが必要となります。


** TODデータ

TODデータはlibgsでの3Dオブジェクト（GsDOBJ系構造体）のパラメータを設定
するパケットが並んだもので、複数のパケットがまとまった１フレーム単位で
処理されます。TODパケットで設定できるパラメータは次の通りです。

	1) オブジェクトの生成／消滅
	2) オブジェクトの親子関係の設定
	3) ローカル座標の値（Scale/Rotation/Transfer/親座標）
	4) TMDデータへのポインタ
	5) その他アトリビュート（表示／非表示etc..)
	6) ユーザ定義パケット

	(注) ユーザ定義パケットは現在未サポート

** モデリングデータ

TMDデータは1つのファイル中に複数のモデリングデータを持つことが可能です。
単一のTODデータで記述するシーンの中で設定するモデリングデータは一つの
TMDデータの中にまとめられていなければなりません。


** TMDデータIDリスト

TMDデータIDリストは、TMDデータ中のモデリングデータの並びと同じ順で、
それぞれのモデルのID番号を並べたテーブルです。C言語のヘッダファイルに
なっており、プログラムでインクルードして使用します。
このファイルは rsdlink でTMDデータを作成する時に -id オプションを
使用することで生成できます。



* ID番号によるデータ管理

TODデータでは3Dオブジェクトやモデリングデータを特定するためにID番号
を使用する必要があります。
TODデータを処理するプログラム中ではID番号によって3Dオブジェクト
すなわちGsDOBJ系列の構造体にアクセスするメカニズムが必要となります。


** オブジェクトテーブル

上記のID管理を実現するためにはあらかじめ3Dオブジェクトを生成する
領域を配列として確保しなければなりません。この領域をオブジェクトテーブ
ルと呼ぶ。

オブジェクトテーブルはTodOBJTABLE構造体として宣言されています。
オブジェクトテーブルの実体はGsDOBJ2の配列で、TodOBJTABLEでは
GsCOORDINATE2,GsCOORD2PARAMをオブジェクトと同数用意し、１対１で対応付
けて処理します。



** 必要となる構造体／関数

ID管理のための構造体／関数として次のものが用意されています。

	[構造体]
		3Dオブジェクト		GsDOBJ2
		座標系			GsCOORDINATE2
		座標系のパラメータ	GsCOORD2PARAM
		オブジェクトテーブル	TodOBJTABLE
	[関数]
		テーブルの初期化	TodInitObjTable()
		新規オブジェクトの生成	TodCreateNewObj()
		オブジェクトの削除	TodRemoveObj()
		オブジェクトの検索	TodSearchObjByID()
		モデリングデータの検索	TodSearchTmdByID()



* TODデータの再生

フレーム毎にTODデータの１フレーム分を解析し、その内容に応じて対応する
DOBJ構造体のパラメータをセットする以外は通常のlibgsでのプログラムと
変わりありません。

TODデータによるアニメーション処理関数では、引数によって３つのモードを
選択可能です。


** 座標のみのアニメーション

あらかじめTodCreateNewObj()によってオブジェクトテーブル内に用意された
オブジェクトの座標値（Rotation/Scale/Transfer）をTODデータによって更新
し、「動き」のみのアニメーションを行なう。
TodSetFrame()を呼ぶ時の引数modeの値をTOD_COORDONLYとします。


** 親子関係の変化

上記に加え、オブジェクト間の親子関係の変化や、モデリングデータの設定／
切替えを含むアニメーションを行ないます。オブジェクトの生成／削除は行な
いません。TodSetFrame()を呼ぶ時の引数modeの値をTOD_NOCREATEとします。


** 完全なシーンの再生

オブジェクトの生成を含む完結したシーンのプレイバックを行ないます。
１フレーム分のTODデータを再生することによって静的なレイアウト情報の設
定を行なうことも出来ます。TodSetFrame()を呼ぶ時の引数modeの値を
TOD_CREATEとします。
